<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OP Sync Dashboard - Order & Absen</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Konfigurasi Font Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Biru muda sangat terang */
        }
        .tab-button {
            padding: 10px 20px;
            font-weight: 600;
            border-radius: 12px 12px 0 0;
            transition: all 0.2s;
        }
        .tab-button.active {
            background-color: white;
            color: #1d4ed8;
            border-bottom: 3px solid #1d4ed8;
        }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen flex flex-col items-center p-4 sm:p-8">
        <!-- Header -->
        <header class="w-full max-w-6xl mb-6 p-4 bg-white shadow-xl rounded-xl">
            <h1 class="text-3xl font-bold text-gray-800">OP Sync Dashboard</h1>
            <p id="auth-status" class="text-sm font-medium text-gray-500 mt-1">Status: Memuat koneksi...</p>
            <p class="text-xs font-mono bg-gray-100 p-2 mt-2 rounded-lg break-all">ID Pengguna: <span id="display-user-id">...</span> | ID Aplikasi: <span id="display-app-id">...</span></p>
        </header>

        <!-- Navigasi Tab -->
        <nav class="w-full max-w-6xl flex justify-start bg-gray-200 rounded-t-xl shadow-md">
            <button class="tab-button active" data-tab="order-input">Input Pesanan</button>
            <button class="tab-button" data-tab="order-tracking">Pelacakan Pesanan</button>
            <button class="tab-button" data-tab="attendance">Absensi (Private)</button>
        </nav>

        <!-- Konten Utama -->
        <main class="w-full max-w-6xl p-6 bg-white shadow-xl rounded-b-xl min-h-[60vh]">
            <!-- Panel Input Pesanan -->
            <div id="order-input" class="tab-content">
                <h2 class="text-2xl font-semibold mb-4 text-blue-700">1. Input Pesanan Baru</h2>
                <form id="order-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                        <label for="item-name" class="block text-sm font-medium text-gray-700">Nama Item / Produk</label>
                        <input type="text" id="item-name" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="quantity" class="block text-sm font-medium text-gray-700">Jumlah</label>
                        <input type="number" id="quantity" required min="1" value="1" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="priority" class="block text-sm font-medium text-gray-700">Prioritas Awal</label>
                        <select id="priority" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="Normal">Normal</option>
                            <option value="Tinggi">Tinggi</option>
                            <option value="Mendesak">Mendesak</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <button type="submit" id="submit-order-btn" 
                                class="w-full py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-150 disabled:bg-blue-300">
                            Kirim Pesanan Baru
                        </button>
                    </div>
                </form>
                <p id="order-message" class="mt-4 p-3 rounded-lg text-center hidden"></p>
            </div>

            <!-- Panel Pelacakan Pesanan -->
            <div id="order-tracking" class="tab-content hidden">
                <h2 class="text-2xl font-semibold mb-4 text-blue-700">2. Pelacakan Pesanan Real-Time</h2>
                <div class="overflow-x-auto rounded-lg shadow-md border">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Pesanan</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pengirim</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Waktu</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="orders-list" class="bg-white divide-y divide-gray-200">
                            <!-- Pesanan akan dimuat di sini -->
                            <tr><td colspan="6" class="p-4 text-center text-gray-500">Memuat data pesanan publik...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Panel Absensi -->
            <div id="attendance" class="tab-content hidden">
                <h2 class="text-2xl font-semibold mb-4 text-blue-700">3. Absensi Harian (Data Pribadi)</h2>
                
                <div class="flex space-x-4 mb-6">
                    <button id="check-in-btn" class="flex-1 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition duration-150 disabled:bg-gray-400">
                        Check In (Masuk)
                    </button>
                    <button id="check-out-btn" class="flex-1 py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition duration-150 disabled:bg-gray-400">
                        Check Out (Pulang)
                    </button>
                </div>
                <p id="absen-message" class="mb-4 p-3 rounded-lg text-center hidden"></p>

                <h3 class="text-xl font-semibold mb-3 text-gray-700">Riwayat Absensi Saya</h3>
                <div class="overflow-x-auto rounded-lg shadow-md border">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Masuk</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pulang</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody id="attendance-list" class="bg-white divide-y divide-gray-200">
                            <!-- Riwayat absen akan dimuat di sini -->
                            <tr><td colspan="4" class="p-4 text-center text-gray-500">Memuat riwayat absensi pribadi...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <!-- Firebase SDK Imports (Module) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc,
            addDoc, 
            setDoc,
            query, 
            onSnapshot, 
            serverTimestamp,
            setLogLevel,
            where
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Konfigurasi dan Inisialisasi Global ---
        setLogLevel('debug');

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'op-sync-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // Elemen UI
        const authStatusEl = document.getElementById('auth-status');
        const displayUserIdEl = document.getElementById('display-user-id');
        const displayAppIdEl = document.getElementById('display-app-id');
        const ordersListEl = document.getElementById('orders-list');
        const attendanceListEl = document.getElementById('attendance-list');
        const orderMessageEl = document.getElementById('order-message');
        const absenMessageEl = document.getElementById('absen-message');
        const checkInBtn = document.getElementById('check-in-btn');
        const checkOutBtn = document.getElementById('check-out-btn');
        const submitOrderBtn = document.getElementById('submit-order-btn');

        // Fungsi utilitas untuk format tanggal
        const formatDate = (timestamp) => {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('id-ID', { year: 'numeric', month: 'short', day: 'numeric' });
        };
        const formatTime = (timestamp) => {
            if (!timestamp) return 'Belum';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        };
        const getCurrentDateKey = () => new Date().toISOString().slice(0, 10); // YYYY-MM-DD

        // --- 1. Inisialisasi Firebase & Autentikasi ---

        if (Object.keys(firebaseConfig).length > 0) {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                displayAppIdEl.textContent = appId;
                
                // Mulai proses autentikasi
                initAuth();
            } catch (error) {
                console.error("Kesalahan inisialisasi Firebase:", error);
                authStatusEl.textContent = 'Status: GAGAL (Kesalahan Konfigurasi)';
            }
        } else {
            authStatusEl.textContent = 'Status: GAGAL (Konfigurasi Firebase Tidak Ada)';
            console.error('Firebase config is missing or invalid.');
        }

        async function initAuth() {
            authStatusEl.textContent = 'Status: Mencoba autentikasi...';

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // Pengguna berhasil masuk
                    userId = user.uid;
                    isAuthReady = true;
                    
                    authStatusEl.textContent = 'Status: Terautentikasi';
                    displayUserIdEl.textContent = userId;

                    // Aktifkan tombol
                    submitOrderBtn.disabled = false;
                    checkInBtn.disabled = false;
                    checkOutBtn.disabled = false;

                    // Mulai mendengarkan data setelah autentikasi
                    setupRealtimeListeners();
                } else {
                    // Coba masuk jika belum ada user
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Kesalahan saat mencoba masuk:", error);
                        authStatusEl.textContent = 'Status: GAGAL MASUK (Periksa Aturan Keamanan)';
                        displayUserIdEl.textContent = 'Anonim/Gagal';
                    }
                }
            });
        }

        // --- 2. Realtime Listeners (Dipanggil setelah auth berhasil) ---

        function setupRealtimeListeners() {
            if (!isAuthReady || !userId) return;

            // a. Listener untuk Order Tracking (Data Publik)
            const ordersPath = `/artifacts/${appId}/public/data/orders`;
            const ordersQuery = query(collection(db, ordersPath));
            
            console.log(`Menyiapkan listener untuk Orders (Publik): ${ordersPath}`);

            onSnapshot(ordersQuery, (snapshot) => {
                const orders = [];
                snapshot.forEach(doc => {
                    orders.push({ id: doc.id, ...doc.data() });
                });
                // Sortir berdasarkan waktu terbaru (descending)
                orders.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                renderOrders(orders);
            }, (error) => {
                console.error("Kesalahan pada listener Orders:", error);
                ordersListEl.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-500">Gagal memuat orders. Izin DITOLAK.</td></tr>`;
            });


            // b. Listener untuk Absensi (Data Privat
